<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн Крестики-Нолики | Играй с друзьями</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white: #ffffff;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --dark-gray: #495057;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f5f7ff;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 i {
            color: var(--primary-color);
        }

        .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .game-container {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .menu-card, .room-card, .join-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .menu-card h2, .room-card h2, .join-card h2 {
            margin-bottom: 25px;
            color: var(--primary-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin: 10px 0;
            width: 100%;
        }

        .btn i {
            font-size: 1rem;
        }

        .btn.primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .btn.primary:hover {
            background-color: #3a5bef;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background-color: var(--secondary-color);
            color: var(--white);
        }

        .btn.secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn.tertiary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--light-gray);
        }

        .btn.tertiary:hover {
            background-color: #e2e6ea;
            transform: translateY(-2px);
        }

        .btn.danger {
            background-color: var(--danger-color);
            color: var(--white);
        }

        .btn.danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn.small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }

        .hidden {
            display: none !important;
        }

        .players-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 25px 0;
        }

        .player {
            flex: 1;
            padding: 15px;
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            text-align: center;
        }

        .vs {
            padding: 0 15px;
            font-weight: bold;
            color: var(--gray);
        }

        .room-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .waiting-message {
            margin-top: 30px;
            text-align: center;
            color: var(--gray);
        }

        .loader {
            border: 4px solid var(--light-gray);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-info {
            margin-bottom: 20px;
            text-align: center;
        }

        .player-turn {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .game-status {
            font-size: 1.1rem;
            color: var(--primary-color);
            font-weight: 600;
            height: 24px;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: 300px;
            height: 300px;
            margin: 20px 0;
        }

        .cell {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .cell:hover {
            background-color: #e2e6ea;
        }

        .cell.x {
            color: var(--primary-color);
        }

        .cell.o {
            color: var(--success-color);
        }

        .game-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        footer i {
            color: var(--danger-color);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--dark-color);
            color: var(--white);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            .game-container {
                padding: 20px;
            }
            
            .menu-card, .room-card, .join-card {
                padding: 20px;
            }
            
            .board {
                width: 280px;
                height: 280px;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.8rem;
                flex-direction: column;
                gap: 5px;
            }
            
            .players-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .player {
                width: 100%;
            }
            
            .room-actions, .game-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn.small {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-times-circle"></i> Онлайн Крестики-Нолики <i class="far fa-circle"></i></h1>
            <p class="subtitle">Играйте с друзьями в реальном времени</p>
        </header>

        <div class="game-container" id="game-container">
            <div class="menu-screen" id="menu-screen">
                <div class="menu-card">
                    <h2>Создать или присоединиться</h2>
                    <button id="create-room-btn" class="btn primary">
                        <i class="fas fa-plus"></i> Создать комнату
                    </button>
                    <button id="join-room-btn" class="btn secondary">
                        <i class="fas fa-user-friends"></i> Присоединиться
                    </button>
                    <button id="play-computer-btn" class="btn tertiary">
                        <i class="fas fa-robot"></i> Играть с компьютером
                    </button>
                </div>
            </div>

            <div class="room-screen hidden" id="room-screen">
                <div class="room-card">
                    <h2 id="room-title">Комната: <span id="room-id-display"></span></h2>
                    <div class="players-info">
                        <div class="player">
                            <i class="fas fa-user"></i> <span id="player1-name">Ожидание игрока...</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="player">
                            <i class="fas fa-user"></i> <span id="player2-name">Ожидание игрока...</span>
                        </div>
                    </div>
                    <div class="room-actions">
                        <button id="copy-link-btn" class="btn small">
                            <i class="fas fa-copy"></i> Копировать ссылку
                        </button>
                        <button id="leave-room-btn" class="btn small danger">
                            <i class="fas fa-sign-out-alt"></i> Покинуть комнату
                        </button>
                    </div>
                    <div class="waiting-message" id="waiting-message">
                        <p>Ожидаем второго игрока...</p>
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <div class="join-screen hidden" id="join-screen">
                <div class="join-card">
                    <h2>Присоединиться к комнате</h2>
                    <div class="input-group">
                        <input type="text" id="room-id-input" placeholder="Введите ID комнаты">
                        <button id="join-room-confirm-btn" class="btn primary">
                            <i class="fas fa-sign-in-alt"></i> Присоединиться
                        </button>
                    </div>
                    <button id="back-to-menu-btn" class="btn secondary">
                        <i class="fas fa-arrow-left"></i> Назад
                    </button>
                </div>
            </div>

            <div class="game-screen hidden" id="game-screen">
                <div class="game-info">
                    <div class="player-turn" id="player-turn">
                        Ваш ход: <span id="current-player"></span>
                    </div>
                    <div class="game-status" id="game-status"></div>
                </div>
                <div class="board" id="board">
                    <!-- Клетки будут добавлены через JS -->
                </div>
                <div class="game-actions">
                    <button id="restart-game-btn" class="btn small">
                        <i class="fas fa-redo"></i> Начать заново
                    </button>
                    <button id="exit-game-btn" class="btn small danger">
                        <i class="fas fa-home"></i> В меню
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>© 2023 Онлайн Крестики-Нолики | Сделано с <i class="fas fa-heart"></i> для игроков</p>
        </footer>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC2oMcl5rA1lzPfEHV_64Gbws6HY0aQnl0",
            authDomain: "tic-tac-toe-game-fabc6.firebaseapp.com",
            databaseURL: "https://tic-tac-toe-game-fabc6-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "tic-tac-toe-game-fabc6",
            storageBucket: "tic-tac-toe-game-fabc6.appspot.com",
            messagingSenderId: "263844844415",
            appId: "1:263844844415:web:2628932fa93f59be75804a"
        };

        // Состояние игры
        const gameState = {
            playerId: null,
            roomId: null,
            playerSymbol: null,
            currentPlayer: null,
            gameBoard: ['', '', '', '', '', '', '', '', ''],
            isGameActive: false,
            isAgainstComputer: false,
            playerName: `Игрок ${Math.floor(Math.random() * 1000)}`
        };

        // DOM элементы
        const elements = {
            menuScreen: document.getElementById('menu-screen'),
            roomScreen: document.getElementById('room-screen'),
            joinScreen: document.getElementById('join-screen'),
            gameScreen: document.getElementById('game-screen'),
            createRoomBtn: document.getElementById('create-room-btn'),
            joinRoomBtn: document.getElementById('join-room-btn'),
            playComputerBtn: document.getElementById('play-computer-btn'),
            joinRoomConfirmBtn: document.getElementById('join-room-confirm-btn'),
            backToMenuBtn: document.getElementById('back-to-menu-btn'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            leaveRoomBtn: document.getElementById('leave-room-btn'),
            restartGameBtn: document.getElementById('restart-game-btn'),
            exitGameBtn: document.getElementById('exit-game-btn'),
            roomIdInput: document.getElementById('room-id-input'),
            roomIdDisplay: document.getElementById('room-id-display'),
            player1Name: document.getElementById('player1-name'),
            player2Name: document.getElementById('player2-name'),
            currentPlayerDisplay: document.getElementById('current-player'),
            gameStatus: document.getElementById('game-status'),
            playerTurn: document.getElementById('player-turn'),
            board: document.getElementById('board'),
            notification: document.getElementById('notification')
        };

        // Инициализация Firebase
        let database;

        function initializeFirebase() {
            // Инициализация Firebase
            const app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            // Генерация уникального ID для игрока
            gameState.playerId = generateId();
        }

        // Генерация случайного ID
        function generateId() {
            return Math.random().toString(36).substring(2, 9);
        }

        // Отображение уведомления
        function showNotification(message, duration = 3000) {
            elements.notification.textContent = message;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, duration);
        }

        // Создание комнаты
        function createRoom() {
            gameState.roomId = generateId();
            gameState.playerSymbol = 'X';
            gameState.currentPlayer = 'X';
            gameState.isGameActive = false;
            gameState.isAgainstComputer = false;
            
            // Обновление интерфейса
            elements.roomIdDisplay.textContent = gameState.roomId;
            elements.player1Name.textContent = gameState.playerName;
            elements.player2Name.textContent = 'Ожидание игрока...';
            
            // Переключение экранов
            elements.menuScreen.classList.add('hidden');
            elements.roomScreen.classList.remove('hidden');
            
            // Создание комнаты в Firebase
            const roomRef = database.ref(`rooms/${gameState.roomId}`);
            
            roomRef.set({
                player1: {
                    id: gameState.playerId,
                    name: gameState.playerName,
                    symbol: 'X'
                },
                player2: null,
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X',
                gameStatus: 'waiting'
            });
            
            // Слушатель изменений в комнате
            roomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                
                if (!room) {
                    // Комната удалена
                    showNotification('Комната была закрыта');
                    resetGame();
                    return;
                }
                
                // Обновление информации об игроках
                if (room.player2) {
                    elements.player2Name.textContent = room.player2.name;
                    
                    if (room.gameStatus === 'playing' && !gameState.isGameActive) {
                        // Начинаем игру
                        gameState.isGameActive = true;
                        document.getElementById('waiting-message').classList.add('hidden');
                        startGame();
                    }
                }
                
                // Обновление доски
                if (room.gameStatus === 'playing') {
                    updateBoard(room.board);
                    updateCurrentPlayer(room.currentPlayer);
                }
                
                // Проверка на завершение игры
                if (room.gameStatus === 'finished') {
                    const winner = checkWinner(room.board);
                    if (winner) {
                        showGameStatus(winner === gameState.playerSymbol ? 'Вы победили!' : 'Вы проиграли!');
                    } else {
                        showGameStatus('Ничья!');
                    }
                    gameState.isGameActive = false;
                }
            });
        }

        // Присоединение к комнате
        function joinRoom(roomId) {
            gameState.roomId = roomId;
            gameState.isAgainstComputer = false;
            
            const roomRef = database.ref(`rooms/${roomId}`);
            
            roomRef.once('value').then((snapshot) => {
                const room = snapshot.val();
                
                if (!room) {
                    showNotification('Комната не найдена');
                    return;
                }
                
                if (room.player2) {
                    showNotification('Комната уже заполнена');
                    return;
                }
                
                // Присоединяемся как второй игрок
                gameState.playerSymbol = 'O';
                gameState.currentPlayer = 'X'; // Первый игрок ходит первым
                
                // Обновление интерфейса
                elements.roomIdDisplay.textContent = gameState.roomId;
                elements.player1Name.textContent = room.player1.name;
                elements.player2Name.textContent = gameState.playerName;
                
                // Переключение экранов
                elements.joinScreen.classList.add('hidden');
                elements.roomScreen.classList.remove('hidden');
                document.getElementById('waiting-message').classList.add('hidden');
                
                // Обновление комнаты в Firebase
                roomRef.update({
                    player2: {
                        id: gameState.playerId,
                        name: gameState.playerName,
                        symbol: 'O'
                    },
                    gameStatus: 'playing'
                });
                
                // Начинаем игру
                gameState.isGameActive = true;
                startGame();
                
                // Слушатель изменений в комнате
                roomRef.on('value', (snapshot) => {
                    const room = snapshot.val();
                    
                    if (!room) {
                        // Комната удалена
                        showNotification('Комната была закрыта');
                        resetGame();
                        return;
                    }
                    
                    // Обновление доски
                    if (room.gameStatus === 'playing') {
                        updateBoard(room.board);
                        updateCurrentPlayer(room.currentPlayer);
                    }
                    
                    // Проверка на завершение игры
                    if (room.gameStatus === 'finished') {
                        const winner = checkWinner(room.board);
                        if (winner) {
                            showGameStatus(winner === gameState.playerSymbol ? 'Вы победили!' : 'Вы проиграли!');
                        } else {
                            showGameStatus('Ничья!');
                        }
                        gameState.isGameActive = false;
                    }
                });
            });
        }

        // Игра против компьютера
        function playAgainstComputer() {
            gameState.roomId = generateId();
            gameState.playerSymbol = 'X';
            gameState.currentPlayer = 'X';
            gameState.isGameActive = true;
            gameState.isAgainstComputer = true;
            
            // Переключение экранов
            elements.menuScreen.classList.add('hidden');
            elements.gameScreen.classList.remove('hidden');
            
            // Инициализация доски
            initializeBoard();
            updateCurrentPlayer('X');
            showGameStatus('');
        }

        // Начало игры
        function startGame() {
            // Переключение экранов
            elements.roomScreen.classList.add('hidden');
            elements.gameScreen.classList.remove('hidden');
            
            // Инициализация доски
            initializeBoard();
            updateCurrentPlayer('X');
            showGameStatus('');
        }

        // Инициализация игровой доски
        function initializeBoard() {
            elements.board.innerHTML = '';
            
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.addEventListener('click', () => handleCellClick(i));
                elements.board.appendChild(cell);
            }
        }

        // Обновление доски
        function updateBoard(board) {
            gameState.gameBoard = [...board];
            
            for (let i = 0; i < 9; i++) {
                const cell = elements.board.children[i];
                cell.textContent = board[i];
                cell.className = 'cell';
                if (board[i] === 'X') cell.classList.add('x');
                if (board[i] === 'O') cell.classList.add('o');
            }
        }

        // Обработка клика по клетке
        function handleCellClick(index) {
            if (!gameState.isGameActive) return;
            if (gameState.gameBoard[index] !== '') return;
            if (gameState.currentPlayer !== gameState.playerSymbol && !gameState.isAgainstComputer) return;
            
            if (gameState.isAgainstComputer) {
                // Игра против компьютера
                if (gameState.currentPlayer !== gameState.playerSymbol) return;
                
                // Ход игрока
                gameState.gameBoard[index] = gameState.playerSymbol;
                updateBoard(gameState.gameBoard);
                
                // Проверка на победу
                const winner = checkWinner(gameState.gameBoard);
                if (winner) {
                    showGameStatus(winner === gameState.playerSymbol ? 'Вы победили!' : 'Компьютер победил!');
                    gameState.isGameActive = false;
                    return;
                }
                
                // Проверка на ничью
                if (!gameState.gameBoard.includes('')) {
                    showGameStatus('Ничья!');
                    gameState.isGameActive = false;
                    return;
                }
                
                // Ход компьютера
                gameState.currentPlayer = 'O';
                updateCurrentPlayer('O');
                
                setTimeout(() => {
                    makeComputerMove();
                }, 1000);
            } else {
                // Игра против другого игрока
                const roomRef = database.ref(`rooms/${gameState.roomId}`);
                
                // Обновление доски
                const newBoard = [...gameState.gameBoard];
                newBoard[index] = gameState.playerSymbol;
                
                // Проверка на победу
                const winner = checkWinner(newBoard);
                const newGameStatus = winner ? 'finished' : !newBoard.includes('') ? 'finished' : 'playing';
                
                // Определение следующего игрока
                const nextPlayer = gameState.currentPlayer === 'X' ? 'O' : 'X';
                
                // Обновление данных в Firebase
                roomRef.update({
                    board: newBoard,
                    currentPlayer: newGameStatus === 'playing' ? nextPlayer : null,
                    gameStatus: newGameStatus
                });
            }
        }

        // Ход компьютера
        function makeComputerMove() {
            if (!gameState.isGameActive) return;
            
            // Простой ИИ: сначала пытается выиграть, затем блокирует игрока, затем случайный ход
            let move;
            
            // 1. Попытка выиграть
            move = findWinningMove('O');
            if (move === undefined) {
                // 2. Попытка блокировать игрока
                move = findWinningMove('X');
                if (move === undefined) {
                    // 3. Случайный ход
                    const emptyCells = [];
                    for (let i = 0; i < 9; i++) {
                        if (gameState.gameBoard[i] === '') emptyCells.push(i);
                    }
                    move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                }
            }
            
            if (move !== undefined) {
                gameState.gameBoard[move] = 'O';
                updateBoard(gameState.gameBoard);
                
                // Проверка на победу
                const winner = checkWinner(gameState.gameBoard);
                if (winner) {
                    showGameStatus(winner === gameState.playerSymbol ? 'Вы победили!' : 'Компьютер победил!');
                    gameState.isGameActive = false;
                    return;
                }
                
                // Проверка на ничью
                if (!gameState.gameBoard.includes('')) {
                    showGameStatus('Ничья!');
                    gameState.isGameActive = false;
                    return;
                }
                
                gameState.currentPlayer = 'X';
                updateCurrentPlayer('X');
            }
        }

        // Поиск выигрышного хода
        function findWinningMove(symbol) {
            const board = gameState.gameBoard;
            
            // Проверка строк
            for (let i = 0; i < 9; i += 3) {
                const row = [board[i], board[i+1], board[i+2]];
                if (row.filter(cell => cell === symbol).length === 2 && row.includes('')) {
                    return i + row.indexOf('');
                }
            }
            
            // Проверка столбцов
            for (let i = 0; i < 3; i++) {
                const col = [board[i], board[i+3], board[i+6]];
                if (col.filter(cell => cell === symbol).length === 2 && col.includes('')) {
                    return i + (col.indexOf('') * 3);
                }
            }
            
            // Проверка диагоналей
            const diag1 = [board[0], board[4], board[8]];
            if (diag1.filter(cell => cell === symbol).length === 2 && diag1.includes('')) {
                return diag1.indexOf('') * 4;
            }
            
            const diag2 = [board[2], board[4], board[6]];
            if (diag2.filter(cell => cell === symbol).length === 2 && diag2.includes('')) {
                return 2 + (diag2.indexOf('') * 2);
            }
            
            return undefined;
        }

        // Проверка победителя
        function checkWinner(board) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // строки
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // столбцы
                [0, 4, 8], [2, 4, 6]             // диагонали
            ];
            
            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            
            return null;
        }

        // Обновление текущего игрока
        function updateCurrentPlayer(player) {
            gameState.currentPlayer = player;
            if (gameState.isAgainstComputer) {
                elements.currentPlayerDisplay.textContent = player === 'X' ? 'Вы (X)' : 'Компьютер (O)';
            } else {
                elements.currentPlayerDisplay.textContent = player === gameState.playerSymbol ? 'Вы' : 'Соперник';
            }
        }

        // Отображение статуса игры
        function showGameStatus(message) {
            elements.gameStatus.textContent = message;
        }

        // Копирование ссылки на комнату
        function copyRoomLink() {
            const url = `${window.location.origin}${window.location.pathname}?room=${gameState.roomId}`;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Ссылка скопирована в буфер обмена');
            });
        }

        // Выход из комнаты
        function leaveRoom() {
            if (gameState.roomId && !gameState.isAgainstComputer) {
                const roomRef = database.ref(`rooms/${gameState.roomId}`);
                roomRef.once('value').then((snapshot) => {
                    const room = snapshot.val();
                    
                    if (room) {
                        // Удаляем игрока из комнаты
                        if (room.player1 && room.player1.id === gameState.playerId) {
                            // Если это создатель комнаты - удаляем комнату
                            roomRef.remove();
                        } else if (room.player2 && room.player2.id === gameState.playerId) {
                            // Если это второй игрок - удаляем только себя
                            roomRef.update({ player2: null, gameStatus: 'waiting' });
                        }
                    }
                });
            }
            
            resetGame();
        }

        // Перезапуск игры
        function restartGame() {
            if (gameState.isAgainstComputer) {
                // Сброс игры с компьютером
                gameState.gameBoard = ['', '', '', '', '', '', '', '', ''];
                gameState.currentPlayer = 'X';
                gameState.isGameActive = true;
                initializeBoard();
                updateCurrentPlayer('X');
                showGameStatus('');
            } else if (gameState.roomId) {
                // Сброс многопользовательской игры
                const roomRef = database.ref(`rooms/${gameState.roomId}`);
                roomRef.update({
                    board: ['', '', '', '', '', '', '', '', ''],
                    currentPlayer: 'X',
                    gameStatus: 'playing'
                });
                
                gameState.isGameActive = true;
                showGameStatus('');
            }
        }

        // Сброс игры
        function resetGame() {
            gameState.roomId = null;
            gameState.playerSymbol = null;
            gameState.currentPlayer = null;
            gameState.gameBoard = ['', '', '', '', '', '', '', '', ''];
            gameState.isGameActive = false;
            gameState.isAgainstComputer = false;
            
            // Сброс интерфейса
            elements.menuScreen.classList.remove('hidden');
            elements.roomScreen.classList.add('hidden');
            elements.joinScreen.classList.add('hidden');
            elements.gameScreen.classList.add('hidden');
            document.getElementById('waiting-message').classList.remove('hidden');
            elements.gameStatus.textContent = '';
        }

        // Проверка параметров URL
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            
            if (roomId) {
                elements.roomIdInput.value = roomId;
                elements.menuScreen.classList.add('hidden');
                elements.joinScreen.classList.remove('hidden');
            }
        }

        // Инициализация событий
        function initializeEvents() {
            // Кнопка создания комнаты
            elements.createRoomBtn.addEventListener('click', createRoom);
            
            // Кнопка присоединения к комнате
            elements.joinRoomBtn.addEventListener('click', () => {
                elements.menuScreen.classList.add('hidden');
                elements.joinScreen.classList.remove('hidden');
            });
            
            // Кнопка игры с компьютером
            elements.playComputerBtn.addEventListener('click', playAgainstComputer);
            
            // Кнопка подтверждения присоединения
            elements.joinRoomConfirmBtn.addEventListener('click', () => {
                const roomId = elements.roomIdInput.value.trim();
                if (roomId) joinRoom(roomId);
            });
            
            // Кнопка "Назад" в меню
            elements.backToMenuBtn.addEventListener('click', resetGame);
            
            // Кнопка копирования ссылки
            elements.copyLinkBtn.addEventListener('click', copyRoomLink);
            
            // Кнопка выхода из комнаты
            elements.leaveRoomBtn.addEventListener('click', leaveRoom);
            
            // Кнопка перезапуска игры
            elements.restartGameBtn.addEventListener('click', restartGame);
            
            // Кнопка выхода в меню
            elements.exitGameBtn.addEventListener('click', resetGame);
        }

        // Инициализация приложения
        function initializeApp() {
            initializeFirebase();
            initializeEvents();
            checkUrlParams();
        }

        // Запуск приложения после загрузки страницы
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
